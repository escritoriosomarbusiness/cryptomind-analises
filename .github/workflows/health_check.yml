name: Verifica√ß√£o de Sa√∫de do Ecossistema

on:
  schedule:
    # Executa 3 vezes ao dia para garantir cobertura
    # 13:00 UTC (10:00 BRT) - Ap√≥s an√°lise de abertura
    - cron: '0 13 * * 1-5'
    # 02:00 UTC (23:00 BRT dia anterior) - Ap√≥s an√°lise de fechamento
    - cron: '0 2 * * 2-6'
    # 18:00 UTC (15:00 BRT) - Verifica√ß√£o adicional
    - cron: '0 18 * * 1-5'
  
  workflow_dispatch:  # Permite execu√ß√£o manual

jobs:
  health-check:
    name: Verificar Sa√∫de do Sistema
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 10  # Busca √∫ltimos 10 commits para verifica√ß√£o
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Instalar depend√™ncias
        run: |
          pip install requests pytz
      
      - name: Executar verifica√ß√£o de sa√∫de
        id: health_check
        run: |
          cd scripts
          python3 health_check.py
        continue-on-error: true
      
      - name: Criar issue se houver falha
        if: steps.health_check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            
            // Verifica se j√° existe uma issue aberta
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check,automated'
            });
            
            if (issues.data.length === 0) {
              // Cria nova issue se n√£o existir
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üö® Falha na Verifica√ß√£o de Sa√∫de do Ecossistema',
                body: `## ‚ö†Ô∏è Problema Detectado
                
**Data/Hora:** ${now}

A verifica√ß√£o autom√°tica de sa√∫de do ecossistema detectou problemas.

### üîç Detalhes

Verifique os logs da execu√ß√£o do workflow para mais informa√ß√µes:
${context.payload.repository.html_url}/actions/runs/${context.runId}

### üìã Checklist de Verifica√ß√£o

- [ ] Verificar se a an√°lise de abertura foi gerada
- [ ] Verificar se a an√°lise de fechamento foi gerada
- [ ] Verificar se os commits foram feitos no GitHub
- [ ] Verificar se o site est√° acess√≠vel e atualizado

### üîß A√ß√µes Recomendadas

1. Revisar os logs do workflow
2. Verificar manualmente os arquivos gerados
3. Testar os scripts localmente se necess√°rio
4. Verificar se as credenciais est√£o corretas

---
*Esta issue foi criada automaticamente pelo sistema de monitoramento.*`,
                labels: ['health-check', 'automated', 'bug']
              });
            }
      
      - name: Comentar em issue existente se houver falha
        if: steps.health_check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            
            // Busca issue aberta
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check,automated'
            });
            
            if (issues.data.length > 0) {
              // Adiciona coment√°rio na issue existente
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `### üîÑ Nova Falha Detectada

**Data/Hora:** ${now}

O problema persiste. Verifique os logs:
${context.payload.repository.html_url}/actions/runs/${context.runId}`
              });
            }
      
      - name: Fechar issue se verifica√ß√£o passou
        if: steps.health_check.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            
            // Busca issue aberta
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check,automated'
            });
            
            if (issues.data.length > 0) {
              // Fecha a issue e adiciona coment√°rio
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `### ‚úÖ Problema Resolvido

**Data/Hora:** ${now}

A verifica√ß√£o de sa√∫de passou com sucesso. O ecossistema est√° funcionando normalmente.

Fechando automaticamente esta issue.`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                state: 'closed'
              });
            }
