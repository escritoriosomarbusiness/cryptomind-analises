{
  "name": "Setup DNP - Alertas TradingView",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "dnp-alert",
        "responseMode": "lastNode",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// Processar dados do TradingView - Setup DNP v1.0\nconst data = $input.first().json.body || $input.first().json;\n\n// Extrair informaÃ§Ãµes do alerta\nconst symbol = data.symbol || 'BTCUSDT';\nconst action = data.action || 'TRIGGER';\nconst direction = data.direction || 'LONG';\nconst setup = data.setup || 'DNP';\nconst timeframe = data.timeframe || '5';\nconst price = parseFloat(data.price) || 0;\n\n// Dados especÃ­ficos do DNP\nconst adx = parseFloat(data.adx) || 0;\nconst remi = parseFloat(data.remi) || 0;\n\n// Dados do candle gatilho e cÃ¡lculos (sÃ³ para CONFIRMED)\nconst triggerHigh = parseFloat(data.triggerHigh) || 0;\nconst triggerLow = parseFloat(data.triggerLow) || 0;\nconst entry = parseFloat(data.entry) || 0;\nconst stopLoss = parseFloat(data.stopLoss) || 0;\nconst risk = parseFloat(data.risk) || 0;\nconst riskPercent = parseFloat(data.riskPercent) || 0;\nconst target1 = parseFloat(data.target1) || 0;\nconst target2 = parseFloat(data.target2) || 0;\nconst trailingDistance = parseFloat(data.trailingDistance) || 0;\n\n// Determinar tipo de alerta\nconst isTrigger = action === 'TRIGGER';\nconst isConfirmed = action === 'CONFIRMED';\n\n// Emoji de direÃ§Ã£o\nconst directionEmoji = direction === 'LONG' ? 'ğŸŸ¢' : 'ğŸ”´';\n\n// Formatar preÃ§os\nconst formatPrice = (p) => {\n  if (p === 0) return '0.00';\n  if (p >= 1000) return p.toFixed(2);\n  if (p >= 1) return p.toFixed(4);\n  return p.toFixed(8);\n};\n\n// Calcular alavancagem sugerida\nconst maxRealRisk = 15;\nconst suggestedLeverage = riskPercent > 0 ? Math.min(10, Math.floor(maxRealRisk / riskPercent)) : 1;\nconst realRisk = riskPercent * suggestedLeverage;\n\nreturn {\n  json: {\n    symbol,\n    action,\n    direction,\n    directionEmoji,\n    setup,\n    timeframe,\n    price: formatPrice(price),\n    adx: adx.toFixed(2),\n    remi: remi.toFixed(2),\n    isTrigger,\n    isConfirmed,\n    triggerHigh: formatPrice(triggerHigh),\n    triggerLow: formatPrice(triggerLow),\n    entry: formatPrice(entry),\n    stopLoss: formatPrice(stopLoss),\n    risk: formatPrice(risk),\n    riskPercent: riskPercent.toFixed(2),\n    target1: formatPrice(target1),\n    target2: formatPrice(target2),\n    trailingDistance: formatPrice(trailingDistance),\n    suggestedLeverage,\n    realRisk: realRisk.toFixed(1),\n    timestamp: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })\n  }\n};"
      },
      "name": "Processar Alerta DNP",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "={{ $json.isTrigger ? 'ğŸ”” <b>' + $json.directionEmoji + ' ' + $json.direction + ' ' + $json.symbol + '</b>\\n\\nğŸ“Š <b>Setup DNP by CryptoMind IA</b>\\nâ±ï¸ ' + $json.timeframe + 'm â€¢ ğŸ• ' + $json.timestamp + '\\n\\nğŸ”” <b>GATILHO ARMADO</b>\\n\\nğŸ¯ <b>Indicadores:</b>\\nâ€¢ ADX: ' + $json.adx + '\\nâ€¢ REMI: ' + $json.remi + '\\n\\nğŸ’° <b>PreÃ§o Atual:</b> $' + $json.price + '\\n\\nğŸ“ <b>Aguardando Rompimento</b>\\n\\nâš ï¸ <i>Entrada serÃ¡ confirmada no rompimento do gatilho</i>' : 'âœ… <b>' + $json.directionEmoji + ' ' + $json.direction + ' ' + $json.symbol + '</b>\\n\\nğŸ“Š <b>Setup DNP by CryptoMind IA</b>\\nâ±ï¸ ' + $json.timeframe + 'm â€¢ ğŸ• ' + $json.timestamp + '\\n\\nâœ… <b>CONFIRMADO POR ROMPIMENTO</b>\\n\\nğŸ¯ <b>Indicadores:</b>\\nâ€¢ ADX: ' + $json.adx + '\\nâ€¢ REMI: ' + $json.remi + '\\n\\nğŸ’° <b>PreÃ§o Atual:</b> $' + $json.price + '\\n\\nğŸš€ <b>Entrada Ativa</b>\\n\\nğŸ¯ <b>Entrada:</b> $' + $json.entry + '\\nğŸ›‘ <b>Stop Loss:</b> $' + $json.stopLoss + ' (' + $json.riskPercent + '%)\\n\\nâš™ï¸ <b>GestÃ£o de Risco:</b>\\nâ€¢ Risco: 1% da banca\\nâ€¢ Alavancagem: ' + $json.suggestedLeverage + 'x\\nâ€¢ Risco Real: ' + $json.realRisk + '%\\n\\nğŸ“ˆ <b>Alvos:</b>\\n1ï¸âƒ£ $' + $json.target1 + ' (1R) â†’ Realizar 40%\\n   âš¡ Mover SL para entrada + Trailing ' + $json.riskPercent + '%\\n2ï¸âƒ£ $' + $json.target2 + ' (2R) â†’ Ativar Trailing Stop ($' + $json.trailingDistance + ')\\n\\nâŒ <b>InvalidaÃ§Ã£o:</b> Se nÃ£o romper no prÃ³ximo candle' }}\\n\\nâš ï¸ <i>NÃ£o Ã© recomendaÃ§Ã£o de investimento</i>",
        "additionalFields": {
          "parseMode": "HTML"
        }
      },
      "name": "Enviar Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [650, 300],
      "credentials": {
        "telegramApi": {
          "id": "YOUR_TELEGRAM_CREDENTIALS_ID",
          "name": "Telegram account"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{"node": "Processar Alerta DNP", "type": "main", "index": 0}]]
    },
    "Processar Alerta DNP": {
      "main": [[{"node": "Enviar Telegram", "type": "main", "index": 0}]]
    }
  }
}
