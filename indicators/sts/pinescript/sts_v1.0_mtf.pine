//@version=6
indicator("STS v1.0 by CryptoMind", shorttitle="STS v1.0", overlay=true)

// ============================================================================
// INPUTS CONFIGUR√ÅVEIS
// ============================================================================

// Candle Martelo
wickToBodyRatio = input.float(2.0, "Raz√£o Pavio/Corpo", minval=1.5, maxval=3.0, step=0.1, group="Candle Martelo", tooltip="Pavio deve ser >= X vezes o corpo")

// EMAs Configur√°veis (HTF)
useEma13 = input.bool(false, "EMA 13 (HTF)", group="EMAs do Fractal Superior")
useEma21 = input.bool(false, "EMA 21 (HTF)", group="EMAs do Fractal Superior")
useEma34 = input.bool(false, "EMA 34 (HTF)", group="EMAs do Fractal Superior")
useEma55 = input.bool(false, "EMA 55 (HTF)", group="EMAs do Fractal Superior")
useEma89 = input.bool(true, "EMA 89 (HTF)", group="EMAs do Fractal Superior", tooltip="Padr√£o ativado")
useEma144 = input.bool(false, "EMA 144 (HTF)", group="EMAs do Fractal Superior")
useEma233 = input.bool(false, "EMA 233 (HTF)", group="EMAs do Fractal Superior")

// Pivots
pivotLookback = input.int(10, "Pivot Lookback", minval=3, maxval=20, group="Pivots S/R")

// Fibonacci
fiboLookback = input.int(10, "Fibonacci Lookback", minval=3, maxval=20, group="Fibonacci Golden Zone")

// Visual
showLabels = input.bool(true, "Mostrar Labels", group="Visual")

// ============================================================================
// FILTRO DE TEND√äNCIA MULTI-TIMEFRAME (MTF)
// ============================================================================

// Detectar timeframe superior (fractal superior)
getHigherTimeframe() =>
    currentTF = timeframe.period
    currentTF == "1" ? "15" : currentTF == "5" ? "60" : currentTF == "15" ? "240" : currentTF == "60" ? "D" : currentTF == "240" ? "W" : currentTF == "D" ? "M" : ""

structuralTimeframe = getHigherTimeframe()
higherTimeframe = structuralTimeframe  // Alias para compatibilidade com alertas

// Buscar dados do timeframe superior
var float htf_ema55 = na
var float htf_ema233 = na
var float htf_close = na
var float htf_ema55_prev = na
var bool htf_trendUp = false
var bool htf_trendDown = false
var bool htf_trendNeutral = true
var string htf_trendText = "NEUTRO"

if structuralTimeframe != ""
    // Buscar EMAs do timeframe superior
    htf_ema55 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 55), lookahead=barmerge.lookahead_off)
    htf_ema233 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 233), lookahead=barmerge.lookahead_off)
    htf_close := request.security(syminfo.tickerid, structuralTimeframe, close, lookahead=barmerge.lookahead_off)
    htf_ema55_prev := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 55)[1], lookahead=barmerge.lookahead_off)
    
    // Determinar tend√™ncia do fractal superior
    if na(htf_ema55) or na(htf_ema233) or na(htf_ema55_prev)
        htf_trendUp := false
        htf_trendDown := false
        htf_trendNeutral := true
        htf_trendText := "NEUTRO"
    else
        htf_trendUp := htf_ema55 > htf_ema233 and htf_ema55 > htf_ema55_prev and htf_close > htf_ema55
        htf_trendDown := htf_ema55 < htf_ema233 and htf_ema55 < htf_ema55_prev and htf_close < htf_ema55
        htf_trendNeutral := not htf_trendUp and not htf_trendDown
        htf_trendText := htf_trendUp ? "ALTA" : htf_trendDown ? "BAIXA" : "NEUTRO"

// ============================================================================
// BUSCAR EMAs DO HTF
// ============================================================================

var float htf_ema13 = na
var float htf_ema21 = na
var float htf_ema34 = na
var float htf_ema89 = na
var float htf_ema144 = na

if structuralTimeframe != ""
    htf_ema13 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 13), lookahead=barmerge.lookahead_off)
    htf_ema21 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 21), lookahead=barmerge.lookahead_off)
    htf_ema34 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 34), lookahead=barmerge.lookahead_off)
    htf_ema55 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 55), lookahead=barmerge.lookahead_off)
    htf_ema89 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 89), lookahead=barmerge.lookahead_off)
    htf_ema144 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 144), lookahead=barmerge.lookahead_off)

// ============================================================================
// PIVOTS MULTI-TIMEFRAME (S/R)
// ============================================================================

var float htf_lastSupport = na
var float htf_lastResistance = na

if structuralTimeframe != ""
    htf_pivotHigh = request.security(syminfo.tickerid, structuralTimeframe, ta.pivothigh(high, pivotLookback, pivotLookback), lookahead=barmerge.lookahead_off)
    htf_pivotLow = request.security(syminfo.tickerid, structuralTimeframe, ta.pivotlow(low, pivotLookback, pivotLookback), lookahead=barmerge.lookahead_off)
    
    if not na(htf_pivotHigh)
        htf_lastResistance := htf_pivotHigh
    if not na(htf_pivotLow)
        htf_lastSupport := htf_pivotLow

// ============================================================================
// FIBONACCI GOLDEN ZONE (0.5-0.618)
// ============================================================================

var array<float> fibHighs = array.new_float(0)
var array<float> fibLows = array.new_float(0)

if structuralTimeframe != ""
    htf_pivotHigh = request.security(syminfo.tickerid, structuralTimeframe, ta.pivothigh(high, fiboLookback, fiboLookback), lookahead=barmerge.lookahead_off)
    htf_pivotLow = request.security(syminfo.tickerid, structuralTimeframe, ta.pivotlow(low, fiboLookback, fiboLookback), lookahead=barmerge.lookahead_off)
    
    if not na(htf_pivotHigh)
        array.push(fibHighs, htf_pivotHigh)
        if array.size(fibHighs) > 10
            array.shift(fibHighs)
    
    if not na(htf_pivotLow)
        array.push(fibLows, htf_pivotLow)
        if array.size(fibLows) > 10
            array.shift(fibLows)

// ============================================================================
// DETEC√á√ÉO DE TRAP
// ============================================================================

// Candle Martelo
body = math.abs(close - open)
lowerWick = open > close ? low - close : low - open
upperWick = open > close ? open - high : close - high

hammerLong = lowerWick >= (body * wickToBodyRatio) and body > 0
hammerShort = upperWick >= (body * wickToBodyRatio) and body > 0

// Valida√ß√£o de Zonas de Rejei√ß√£o
tolerance = 0.002  // 0.2%

// SR Validation
srRejectionLong = not na(htf_lastSupport) and low <= htf_lastSupport * (1 + tolerance) and close > htf_lastSupport
srRejectionShort = not na(htf_lastResistance) and high >= htf_lastResistance * (1 - tolerance) and close < htf_lastResistance

// Fibonacci Validation
goldenZoneTopLong = float(na)
goldenZoneBottomLong = float(na)
goldenZoneTopShort = float(na)
goldenZoneBottomShort = float(na)

if array.size(fibHighs) > 0 and array.size(fibLows) > 0
    lastHigh = array.get(fibHighs, array.size(fibHighs) - 1)
    lastLow = array.get(fibLows, array.size(fibLows) - 1)
    
    // LONG: Retra√ß√£o de alta (√∫ltimo pivot low at√© √∫ltimo pivot high)
    goldenZoneTopLong := lastLow + (lastHigh - lastLow) * 0.618
    goldenZoneBottomLong := lastLow + (lastHigh - lastLow) * 0.5
    
    // SHORT: Retra√ß√£o de baixa (√∫ltimo pivot high at√© √∫ltimo pivot low)
    goldenZoneTopShort := lastHigh - (lastHigh - lastLow) * 0.5
    goldenZoneBottomShort := lastHigh - (lastHigh - lastLow) * 0.618

fiboRejectionLong = not na(goldenZoneBottomLong) and not na(goldenZoneTopLong) and low <= goldenZoneTopLong and low >= goldenZoneBottomLong and close > goldenZoneBottomLong
fiboRejectionShort = not na(goldenZoneBottomShort) and not na(goldenZoneTopShort) and high >= goldenZoneBottomShort and high <= goldenZoneTopShort and close < goldenZoneTopShort

// EMA Validation (HTF)
emaRejectionLong = false
emaRejectionShort = false
emasRejectedList = ""
emasRejectedCount = 0

// Check each EMA
if useEma13 and not na(htf_ema13)
    if low <= htf_ema13 * (1 + tolerance) and close > htf_ema13
        emaRejectionLong := true
        emasRejectedList := emasRejectedList == "" ? "13" : emasRejectedList + "/13"
        emasRejectedCount += 1
    if high >= htf_ema13 * (1 - tolerance) and close < htf_ema13
        emaRejectionShort := true
        emasRejectedList := emasRejectedList == "" ? "13" : emasRejectedList + "/13"
        emasRejectedCount += 1

if useEma21 and not na(htf_ema21)
    if low <= htf_ema21 * (1 + tolerance) and close > htf_ema21
        emaRejectionLong := true
        emasRejectedList := emasRejectedList == "" ? "21" : emasRejectedList + "/21"
        emasRejectedCount += 1
    if high >= htf_ema21 * (1 - tolerance) and close < htf_ema21
        emaRejectionShort := true
        emasRejectedList := emasRejectedList == "" ? "21" : emasRejectedList + "/21"
        emasRejectedCount += 1

if useEma34 and not na(htf_ema34)
    if low <= htf_ema34 * (1 + tolerance) and close > htf_ema34
        emaRejectionLong := true
        emasRejectedList := emasRejectedList == "" ? "34" : emasRejectedList + "/34"
        emasRejectedCount += 1
    if high >= htf_ema34 * (1 - tolerance) and close < htf_ema34
        emaRejectionShort := true
        emasRejectedList := emasRejectedList == "" ? "34" : emasRejectedList + "/34"
        emasRejectedCount += 1

if useEma55 and not na(htf_ema55)
    if low <= htf_ema55 * (1 + tolerance) and close > htf_ema55
        emaRejectionLong := true
        emasRejectedList := emasRejectedList == "" ? "55" : emasRejectedList + "/55"
        emasRejectedCount += 1
    if high >= htf_ema55 * (1 - tolerance) and close < htf_ema55
        emaRejectionShort := true
        emasRejectedList := emasRejectedList == "" ? "55" : emasRejectedList + "/55"
        emasRejectedCount += 1

if useEma89 and not na(htf_ema89)
    if low <= htf_ema89 * (1 + tolerance) and close > htf_ema89
        emaRejectionLong := true
        emasRejectedList := emasRejectedList == "" ? "89" : emasRejectedList + "/89"
        emasRejectedCount += 1
    if high >= htf_ema89 * (1 - tolerance) and close < htf_ema89
        emaRejectionShort := true
        emasRejectedList := emasRejectedList == "" ? "89" : emasRejectedList + "/89"
        emasRejectedCount += 1

if useEma144 and not na(htf_ema144)
    if low <= htf_ema144 * (1 + tolerance) and close > htf_ema144
        emaRejectionLong := true
        emasRejectedList := emasRejectedList == "" ? "144" : emasRejectedList + "/144"
        emasRejectedCount += 1
    if high >= htf_ema144 * (1 - tolerance) and close < htf_ema144
        emaRejectionShort := true
        emasRejectedList := emasRejectedList == "" ? "144" : emasRejectedList + "/144"
        emasRejectedCount += 1

// Conflu√™ncias
confluenceLong = (srRejectionLong ? 1 : 0) + (fiboRejectionLong ? 1 : 0) + (emaRejectionLong ? 1 : 0)
confluenceShort = (srRejectionShort ? 1 : 0) + (fiboRejectionShort ? 1 : 0) + (emaRejectionShort ? 1 : 0)

// TRAP Detectada
trapLong = hammerLong and confluenceLong >= 1
trapShort = hammerShort and confluenceShort >= 1

// ============================================================================
// CLASSIFICA√á√ÉO MTF
// ============================================================================

setupQuality = ""
fishingType = ""

if trapLong
    if htf_trendUp
        setupQuality := "PREMIUM"
        fishingType := "Continua√ß√£o"
    else if htf_trendDown
        setupQuality := "CONTRA"
        fishingType := "Bottom Fishing"
    else
        setupQuality := "CAUTELA"
        fishingType := "Neutro"

if trapShort
    if htf_trendDown
        setupQuality := "PREMIUM"
        fishingType := "Continua√ß√£o"
    else if htf_trendUp
        setupQuality := "CONTRA"
        fishingType := "Top Fishing"
    else
        setupQuality := "CAUTELA"
        fishingType := "Neutro"

// Bloquear sinais CAUTELA (HTF neutro)
blockSignal = setupQuality == "CAUTELA"

// ============================================================================
// SISTEMA DE SINAIS
// ============================================================================

var int lastSignalBar = na
cooldownPeriod = 5

// Cooldown
canSignal = na(lastSignalBar) or (bar_index - lastSignalBar) >= cooldownPeriod

// Vari√°veis de estado
var bool signalArmed = false
var float triggerPrice = na
var string signalDirection = ""
var int signalArmedBar = na
var int signalConfluence = na
var string signalSetupQuality = ""
var string signalFishingType = ""
var string signalRejectionZones = ""
var string signalEmasRejected = ""
var int signalEmasCount = 0
var float signalWickRatio = na
var float signalTriggerLow = na
var float signalTriggerHigh = na

// GATILHO: Armar sinal
if (trapLong or trapShort) and canSignal and not blockSignal and not signalArmed
    signalArmed := true
    triggerPrice := trapLong ? high : low
    signalTriggerHigh := trapLong ? high : na
    signalTriggerLow := trapShort ? low : na
    signalDirection := trapLong ? "LONG" : "SHORT"
    signalArmedBar := bar_index
    signalConfluence := trapLong ? confluenceLong : confluenceShort
    signalSetupQuality := setupQuality
    signalFishingType := fishingType
    signalEmasRejected := emasRejectedList
    signalEmasCount := emasRejectedCount
    signalWickRatio := trapLong ? lowerWick / body : upperWick / body
    
    // Montar texto de zonas rejeitadas
    zonesText = ""
    if trapLong
        if srRejectionLong
            zonesText := zonesText == "" ? "SR" : zonesText + " + SR"
        if fiboRejectionLong
            zonesText := zonesText == "" ? "Fibo 0.5-0.618" : zonesText + " + Fibo 0.5-0.618"
        if emaRejectionLong
            zonesText := zonesText == "" ? "EMA" : zonesText + " + EMA"
    else
        if srRejectionShort
            zonesText := zonesText == "" ? "SR" : zonesText + " + SR"
        if fiboRejectionShort
            zonesText := zonesText == "" ? "Fibo 0.5-0.618" : zonesText + " + Fibo 0.5-0.618"
        if emaRejectionShort
            zonesText := zonesText == "" ? "EMA" : zonesText + " + EMA"
    
    signalRejectionZones := zonesText
    
    confluenceText = signalConfluence == 1 ? "Simples" : signalConfluence == 2 ? "Dupla ‚≠ê" : "Tripla üåüüåü"
    
    // Label de GATILHO
    if showLabels
        labelText = "üîî " + signalDirection + "\n" + signalSetupQuality + "\n" + confluenceText + "\n" + signalRejectionZones
        if signalEmasCount > 1
            labelText := labelText + "\nEMA " + signalEmasRejected + " üî¥"
        label.new(bar_index, trapLong ? low : high, labelText, style=trapLong ? label.style_label_up : label.style_label_down, color=trapLong ? color.new(color.green, 80) : color.new(color.red, 80), textcolor=trapLong ? color.green : color.red, size=size.small)

// CONFIRMA√á√ÉO: Verificar rompimento no candle seguinte (apenas 1 candle)
if signalArmed
    barsElapsed = bar_index - signalArmedBar
    
    if barsElapsed == 1  // Apenas 1 candle depois
        if signalDirection == "LONG" and close > triggerPrice
            // CONFIRMADO LONG
            signalArmed := false
            lastSignalBar := bar_index
            
            confluenceText = signalConfluence == 1 ? "Simples" : signalConfluence == 2 ? "Dupla ‚≠ê" : "Tripla üåüüåü"
            
            // Label de CONFIRMA√á√ÉO
            if showLabels
                labelText = "‚úÖ LONG\n" + signalSetupQuality + "\n" + confluenceText + "\n" + signalRejectionZones
                if signalEmasCount > 1
                    labelText := labelText + "\nEMA " + signalEmasRejected + " üî¥"
                label.new(bar_index, low, labelText, style=label.style_label_up, color=color.new(color.green, 0), textcolor=color.white, size=size.normal)
        
        else if signalDirection == "SHORT" and close < triggerPrice
            // CONFIRMADO SHORT
            signalArmed := false
            lastSignalBar := bar_index
            
            confluenceText = signalConfluence == 1 ? "Simples" : signalConfluence == 2 ? "Dupla ‚≠ê" : "Tripla üåüüåü"
            
            // Label de CONFIRMA√á√ÉO
            if showLabels
                labelText = "‚úÖ SHORT\n" + signalSetupQuality + "\n" + confluenceText + "\n" + signalRejectionZones
                if signalEmasCount > 1
                    labelText := labelText + "\nEMA " + signalEmasRejected + " üî¥"
                label.new(bar_index, high, labelText, style=label.style_label_down, color=color.new(color.red, 0), textcolor=color.white, size=size.normal)
        
        else
            // EXPIRADO (n√£o rompeu no candle seguinte)
            signalArmed := false
    
    else if barsElapsed > 1
        // EXPIRADO (passou do candle seguinte)
        signalArmed := false

// ============================================
// ALERTAS COM JSON DIN√ÇMICO - PADR√ÉO DNP/TRS
// ============================================
// Calcular wickToBodyRatio para o alerta
var float alertWickToBodyRatio = na

if trapLong
    alertWickToBodyRatio := body > 0 ? lowerWick / body : 0
else if trapShort
    alertWickToBodyRatio := body > 0 ? math.abs(upperWick) / body : 0

// Alerta de GATILHO LONG
if trapLong
    if barstate.isconfirmed
        alertJson = '{"symbol":"' + syminfo.ticker + '","action":"TRIGGER","direction":"LONG","setup":"STS","timeframe":"' + timeframe.period + '","price":"' + str.tostring(close, '#.########') + '","triggerHigh":"' + str.tostring(triggerPrice, '#.########') + '","wickToBodyRatio":"' + str.tostring(alertWickToBodyRatio, '#.#') + '","confluence":"' + signalConfluence + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":"' + str.tostring(signalEmasCount) + '","setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + higherTimeframe + '","fishingType":"' + signalFishingType + '"}'
        alert(alertJson, alert.freq_once_per_bar)

// Alerta de GATILHO SHORT
if trapShort
    if barstate.isconfirmed
        alertJson = '{"symbol":"' + syminfo.ticker + '","action":"TRIGGER","direction":"SHORT","setup":"STS","timeframe":"' + timeframe.period + '","price":"' + str.tostring(close, '#.########') + '","triggerLow":"' + str.tostring(triggerPrice, '#.########') + '","wickToBodyRatio":"' + str.tostring(alertWickToBodyRatio, '#.#') + '","confluence":"' + signalConfluence + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":"' + str.tostring(signalEmasCount) + '","setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + higherTimeframe + '","fishingType":"' + signalFishingType + '"}'
        alert(alertJson, alert.freq_once_per_bar)

// Alerta de CONFIRMA√á√ÉO LONG
if signalArmed and signalDirection == "LONG" and bar_index - signalArmedBar == 1 and close > triggerPrice
    if barstate.isconfirmed
        // Calcular entry, SL, alvos e trailing
        tickSize = syminfo.mintick
        entryPrice = triggerPrice
        stopLossPrice = signalTriggerLow - tickSize
        riskValue = entryPrice - stopLossPrice
        riskPercent = (riskValue / entryPrice) * 100
        
        target1 = entryPrice + riskValue
        target2 = entryPrice + (riskValue * 2)
        trailingDistance = riskValue * 0.5
        
        alertJson = '{"symbol":"' + syminfo.ticker + '","action":"CONFIRMED","direction":"LONG","setup":"STS","timeframe":"' + timeframe.period + '","price":"' + str.tostring(close, '#.########') + '","entry":"' + str.tostring(entryPrice, '#.########') + '","stopLoss":"' + str.tostring(stopLossPrice, '#.########') + '","risk":"' + str.tostring(riskValue, '#.########') + '","riskPercent":"' + str.tostring(riskPercent, '#.##') + '","target1":"' + str.tostring(target1, '#.########') + '","target2":"' + str.tostring(target2, '#.########') + '","trailingDistance":"' + str.tostring(trailingDistance, '#.########') + '","triggerHigh":"' + str.tostring(triggerPrice, '#.########') + '","wickToBodyRatio":"' + str.tostring(alertWickToBodyRatio, '#.#') + '","confluence":"' + signalConfluence + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":"' + str.tostring(signalEmasCount) + '","setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + higherTimeframe + '","fishingType":"' + signalFishingType + '"}'
        alert(alertJson, alert.freq_once_per_bar)

// Alerta de CONFIRMA√á√ÉO SHORT
if signalArmed and signalDirection == "SHORT" and bar_index - signalArmedBar == 1 and close < triggerPrice
    if barstate.isconfirmed
        // Calcular entry, SL, alvos e trailing
        tickSize = syminfo.mintick
        entryPrice = triggerPrice
        stopLossPrice = signalTriggerHigh + tickSize
        riskValue = stopLossPrice - entryPrice
        riskPercent = (riskValue / entryPrice) * 100
        
        target1 = entryPrice - riskValue
        target2 = entryPrice - (riskValue * 2)
        trailingDistance = riskValue * 0.5
        
        alertJson = '{"symbol":"' + syminfo.ticker + '","action":"CONFIRMED","direction":"SHORT","setup":"STS","timeframe":"' + timeframe.period + '","price":"' + str.tostring(close, '#.########') + '","entry":"' + str.tostring(entryPrice, '#.########') + '","stopLoss":"' + str.tostring(stopLossPrice, '#.########') + '","risk":"' + str.tostring(riskValue, '#.########') + '","riskPercent":"' + str.tostring(riskPercent, '#.##') + '","target1":"' + str.tostring(target1, '#.########') + '","target2":"' + str.tostring(target2, '#.########') + '","trailingDistance":"' + str.tostring(trailingDistance, '#.########') + '","triggerLow":"' + str.tostring(triggerPrice, '#.########') + '","wickToBodyRatio":"' + str.tostring(alertWickToBodyRatio, '#.#') + '","confluence":"' + signalConfluence + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":"' + str.tostring(signalEmasCount) + '","setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + higherTimeframe + '","fishingType":"' + signalFishingType + '"}'
        alert(alertJson, alert.freq_once_per_bar)
