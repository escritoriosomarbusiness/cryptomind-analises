// STS by CryptoMind v1.0 - Stormer Trap Setup
// ¬© CryptoMind IA - STS (Stormer Trap Setup) v1.0

//@version=6
indicator("STS by CryptoMind v1.0", shorttitle="STS v1.0", overlay=true, max_labels_count=50)

// ============================================
// CONFIGURA√á√ïES GERAIS
// ============================================
wickToBodyRatio = input.float(2.0, "Propor√ß√£o M√≠n. Pavio/Corpo", minval=1.5, maxval=3.0, step=0.1, group="Candle Martelo", tooltip="Pavio deve ser >= X vezes o corpo")
cooldownCandles = input.int(5, "Cooldown entre sinais", minval=5, maxval=30, group="Geral")
showLabels = input.bool(true, "Mostrar Labels", group="Visual")

// ============================================
// CONFIGURA√á√ïES - M√öLTIPLAS EMAs (HTF)
// ============================================
useEMA13 = input.bool(false, "EMA 13 (HTF)", group="EMAs do Fractal Superior")
useEMA21 = input.bool(false, "EMA 21 (HTF)", group="EMAs do Fractal Superior")
useEMA34 = input.bool(false, "EMA 34 (HTF)", group="EMAs do Fractal Superior")
useEMA55 = input.bool(false, "EMA 55 (HTF)", group="EMAs do Fractal Superior")
useEMA89 = input.bool(true, "EMA 89 (HTF)", group="EMAs do Fractal Superior")
useEMA144 = input.bool(false, "EMA 144 (HTF)", group="EMAs do Fractal Superior")
useEMA233 = input.bool(false, "EMA 233 (HTF)", group="EMAs do Fractal Superior")
emaTolerance = input.float(0.2, "Toler√¢ncia Toque EMA (%)", minval=0.1, maxval=1.0, step=0.1, group="EMAs do Fractal Superior")

// ============================================
// CONFIGURA√á√ïES - PIVOTS MULTI-TIMEFRAME
// ============================================
usePivots = input.bool(true, "Usar Pivots (SR) do HTF", group="Pivots MTF", tooltip="Busca suporte/resist√™ncia do timeframe superior")
pivotLookback = input.int(10, "Lookback para Pivots", minval=5, maxval=50, group="Pivots MTF")
pivotTolerance = input.float(0.1, "Toler√¢ncia zona SR (%)", minval=0.1, maxval=2.0, step=0.1, group="Pivots MTF")

// ============================================
// CONFIGURA√á√ïES - FIBONACCI (GOLDEN ZONE)
// ============================================
useFibonacci = input.bool(true, "Usar Golden Zone (Fibo 0.5-0.618)", group="Fibonacci", tooltip="Busca retra√ß√£o de Fibonacci do HTF")
fibLookback = input.int(10, "Lookback para Pivots Fibonacci", minval=5, maxval=20, group="Fibonacci")

// ============================================
// DETEC√á√ÉO AUTOM√ÅTICA DE TIMEFRAME ESTRUTURAL
// ============================================
getStructuralTimeframe() =>
    currentTF = timeframe.period
    
    // Mapeamento: TF Operacional -> TF Estrutural (HTF)
    structuralTF = switch currentTF
        "1"   => "15"      // 1 min -> 15 min
        "5"   => "60"      // 5 min -> 1 hora
        "15"  => "240"     // 15 min -> 4 horas
        "60"  => "D"       // 1 hora -> Di√°rio
        "240" => "W"       // 4 horas -> Semanal
        "D"   => "M"       // Di√°rio -> Mensal
        => "60"            // Default: 1 hora
    
    structuralTF

structuralTimeframe = getStructuralTimeframe()

// ============================================
// BUSCAR EMAs DO TIMEFRAME SUPERIOR (HTF)
// ============================================
var float htf_ema13 = na
var float htf_ema21 = na
var float htf_ema34 = na
var float htf_ema55 = na
var float htf_ema89 = na
var float htf_ema144 = na
var float htf_ema233 = na

if structuralTimeframe != ""
    htf_ema13 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 13), lookahead=barmerge.lookahead_off)
    htf_ema21 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 21), lookahead=barmerge.lookahead_off)
    htf_ema34 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 34), lookahead=barmerge.lookahead_off)
    htf_ema55 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 55), lookahead=barmerge.lookahead_off)
    htf_ema89 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 89), lookahead=barmerge.lookahead_off)
    htf_ema144 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 144), lookahead=barmerge.lookahead_off)
    htf_ema233 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 233), lookahead=barmerge.lookahead_off)

// ============================================
// FILTRO DE TEND√äNCIA MULTI-TIMEFRAME (MTF)
// ============================================
var float htf_close = na
var float htf_ema55_prev = na
var bool htf_trendUp = false
var bool htf_trendDown = false
var bool htf_trendNeutral = true
var string htf_trendText = "NEUTRO"

if structuralTimeframe != ""
    htf_close := request.security(syminfo.tickerid, structuralTimeframe, close, lookahead=barmerge.lookahead_off)
    htf_ema55_prev := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 55)[1], lookahead=barmerge.lookahead_off)
    
    // Determinar tend√™ncia do fractal superior
    if na(htf_ema55) or na(htf_ema233) or na(htf_ema55_prev)
        htf_trendUp := false
        htf_trendDown := false
        htf_trendNeutral := true
        htf_trendText := "NEUTRO"
    else
        htf_trendUp := htf_ema55 > htf_ema233 and htf_ema55 > htf_ema55_prev and htf_close > htf_ema55
        htf_trendDown := htf_ema55 < htf_ema233 and htf_ema55 < htf_ema55_prev and htf_close < htf_ema55
        htf_trendNeutral := not htf_trendUp and not htf_trendDown
        htf_trendText := htf_trendUp ? "ALTA" : htf_trendDown ? "BAIXA" : "NEUTRO"

// ============================================
// PIVOTS MULTI-TIMEFRAME (SR)
// ============================================
var float htf_lastSupport = na
var float htf_lastResistance = na

if usePivots and structuralTimeframe != ""
    htf_pivotHigh = request.security(syminfo.tickerid, structuralTimeframe, ta.pivothigh(high, pivotLookback, pivotLookback), lookahead=barmerge.lookahead_off)
    htf_pivotLow = request.security(syminfo.tickerid, structuralTimeframe, ta.pivotlow(low, pivotLookback, pivotLookback), lookahead=barmerge.lookahead_off)
    
    if not na(htf_pivotHigh)
        htf_lastResistance := htf_pivotHigh
    if not na(htf_pivotLow)
        htf_lastSupport := htf_pivotLow

// ============================================
// FIBONACCI (GOLDEN ZONE) DO HTF
// ============================================
var array<float> fibHighs = array.new_float(0)
var array<float> fibLows = array.new_float(0)

if useFibonacci and structuralTimeframe != ""
    htf_fibPivotHigh = request.security(syminfo.tickerid, structuralTimeframe, ta.pivothigh(high, fibLookback, fibLookback), lookahead=barmerge.lookahead_off)
    htf_fibPivotLow = request.security(syminfo.tickerid, structuralTimeframe, ta.pivotlow(low, fibLookback, fibLookback), lookahead=barmerge.lookahead_off)
    
    if not na(htf_fibPivotHigh)
        array.push(fibHighs, htf_fibPivotHigh)
        if array.size(fibHighs) > 10
            array.shift(fibHighs)
    
    if not na(htf_fibPivotLow)
        array.push(fibLows, htf_fibPivotLow)
        if array.size(fibLows) > 10
            array.shift(fibLows)

// ============================================
// DETEC√á√ÉO DE CANDLE MARTELO
// ============================================
body = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low

// LONG: Pavio inferior >= X * corpo
hammerLong = lowerWick >= (wickToBodyRatio * body) and body > 0

// SHORT: Pavio superior >= X * corpo
hammerShort = upperWick >= (wickToBodyRatio * body) and body > 0

// ============================================
// VALIDA√á√ÉO DE TRAP NAS EMAs DO HTF
// ============================================
emaRejectionLong = false
emaRejectionShort = false
emasRejectedList = ""
emasRejectedCount = 0

tolerance = emaTolerance / 100

// Verificar rejei√ß√£o em cada EMA do HTF
if useEMA13 and not na(htf_ema13)
    if low <= htf_ema13 * (1 + tolerance) and close > htf_ema13
        emaRejectionLong := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "13"
        emasRejectedCount += 1
    if high >= htf_ema13 * (1 - tolerance) and close < htf_ema13
        emaRejectionShort := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "13"
        emasRejectedCount += 1

if useEMA21 and not na(htf_ema21)
    if low <= htf_ema21 * (1 + tolerance) and close > htf_ema21
        emaRejectionLong := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "21"
        emasRejectedCount += 1
    if high >= htf_ema21 * (1 - tolerance) and close < htf_ema21
        emaRejectionShort := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "21"
        emasRejectedCount += 1

if useEMA34 and not na(htf_ema34)
    if low <= htf_ema34 * (1 + tolerance) and close > htf_ema34
        emaRejectionLong := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "34"
        emasRejectedCount += 1
    if high >= htf_ema34 * (1 - tolerance) and close < htf_ema34
        emaRejectionShort := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "34"
        emasRejectedCount += 1

if useEMA55 and not na(htf_ema55)
    if low <= htf_ema55 * (1 + tolerance) and close > htf_ema55
        emaRejectionLong := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "55"
        emasRejectedCount += 1
    if high >= htf_ema55 * (1 - tolerance) and close < htf_ema55
        emaRejectionShort := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "55"
        emasRejectedCount += 1

if useEMA89 and not na(htf_ema89)
    if low <= htf_ema89 * (1 + tolerance) and close > htf_ema89
        emaRejectionLong := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "89"
        emasRejectedCount += 1
    if high >= htf_ema89 * (1 - tolerance) and close < htf_ema89
        emaRejectionShort := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "89"
        emasRejectedCount += 1

if useEMA144 and not na(htf_ema144)
    if low <= htf_ema144 * (1 + tolerance) and close > htf_ema144
        emaRejectionLong := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "144"
        emasRejectedCount += 1
    if high >= htf_ema144 * (1 - tolerance) and close < htf_ema144
        emaRejectionShort := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "144"
        emasRejectedCount += 1

if useEMA233 and not na(htf_ema233)
    if low <= htf_ema233 * (1 + tolerance) and close > htf_ema233
        emaRejectionLong := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "233"
        emasRejectedCount += 1
    if high >= htf_ema233 * (1 - tolerance) and close < htf_ema233
        emaRejectionShort := true
        emasRejectedList := emasRejectedList + (emasRejectedList == "" ? "" : "/") + "233"
        emasRejectedCount += 1

// ============================================
// VALIDA√á√ÉO DE TRAP EM PIVOTS (SR)
// ============================================
pivotRejectionLong = false
pivotRejectionShort = false

if usePivots
    srTolerance = pivotTolerance / 100
    
    // LONG: Pre√ßo toca suporte e fecha acima
    if not na(htf_lastSupport)
        if low <= htf_lastSupport * (1 + srTolerance) and close > htf_lastSupport
            pivotRejectionLong := true
    
    // SHORT: Pre√ßo toca resist√™ncia e fecha abaixo
    if not na(htf_lastResistance)
        if high >= htf_lastResistance * (1 - srTolerance) and close < htf_lastResistance
            pivotRejectionShort := true

// ============================================
// VALIDA√á√ÉO DE TRAP EM FIBONACCI (GOLDEN ZONE)
// ============================================
fibRejectionLong = false
fibRejectionShort = false

if useFibonacci
    if array.size(fibHighs) > 0 and array.size(fibLows) > 0
        lastHigh = array.get(fibHighs, array.size(fibHighs) - 1)
        lastLow = array.get(fibLows, array.size(fibLows) - 1)
        
        fibRange = lastHigh - lastLow
        fib50 = lastLow + (fibRange * 0.5)
        fib618 = lastLow + (fibRange * 0.618)
        
        goldenZoneTop = math.max(fib50, fib618)
        goldenZoneBottom = math.min(fib50, fib618)
        
        // LONG: Pre√ßo entra na Golden Zone e fecha acima
        if low <= goldenZoneTop and low >= goldenZoneBottom and close > goldenZoneTop
            fibRejectionLong := true
        
        // SHORT: Pre√ßo entra na Golden Zone e fecha abaixo
        if high >= goldenZoneBottom and high <= goldenZoneTop and close < goldenZoneBottom
            fibRejectionShort := true

// ============================================
// SISTEMA DE CONFLU√äNCIAS
// ============================================
confluenceLong = 0
confluenceShort = 0

if pivotRejectionLong
    confluenceLong += 1
if fibRejectionLong
    confluenceLong += 1
if emaRejectionLong
    confluenceLong += 1

if pivotRejectionShort
    confluenceShort += 1
if fibRejectionShort
    confluenceShort += 1
if emaRejectionShort
    confluenceShort += 1

// ============================================
// DETEC√á√ÉO DE TRAP (GATILHO)
// ============================================
trapLong = hammerLong and confluenceLong >= 1
trapShort = hammerShort and confluenceShort >= 1

// ============================================
// CLASSIFICA√á√ÉO MTF
// ============================================
setupQuality = ""
fishingType = ""

if trapLong
    if htf_trendUp
        setupQuality := "PREMIUM"
        fishingType := "Continua√ß√£o"
    else if htf_trendDown
        setupQuality := "CONTRA"
        fishingType := "Bottom Fishing"
    else
        setupQuality := "CAUTELA"
        fishingType := "Neutro"

if trapShort
    if htf_trendDown
        setupQuality := "PREMIUM"
        fishingType := "Continua√ß√£o"
    else if htf_trendUp
        setupQuality := "CONTRA"
        fishingType := "Top Fishing"
    else
        setupQuality := "CAUTELA"
        fishingType := "Neutro"

// ============================================
// FILTRO MTF ATUANTE (BLOQUEAR CAUTELA)
// ============================================
signalBlocked = setupQuality == "CAUTELA"

// ============================================
// COOLDOWN
// ============================================
var int lastSignalBar = na

if not signalBlocked and (trapLong or trapShort)
    if na(lastSignalBar) or (bar_index - lastSignalBar) >= cooldownCandles
        lastSignalBar := bar_index

// ============================================
// SISTEMA DE CONFIRMA√á√ÉO POR ROMPIMENTO
// ============================================
var bool signalArmed = false
var float triggerPrice = na
var string signalDirection = ""
var int signalArmedBar = na
var string signalSetupQuality = ""
var string signalFishingType = ""
var int signalConfluence = 0
var string signalRejectionZones = ""
var string signalEmasRejected = ""
var int signalEmasCount = 0
var float signalWickRatio = 0.0

// GATILHO: Armar sinal
if not signalBlocked and (trapLong or trapShort) and not signalArmed
    if na(lastSignalBar) or bar_index == lastSignalBar
        signalArmed := true
        signalDirection := trapLong ? "LONG" : "SHORT"
        triggerPrice := trapLong ? high : low
        signalArmedBar := bar_index
        signalSetupQuality := setupQuality
        signalFishingType := fishingType
        signalConfluence := trapLong ? confluenceLong : confluenceShort
        signalEmasCount := emasRejectedCount
        signalEmasRejected := emasRejectedCount > 0 ? ("EMA " + emasRejectedList) : ""
        signalWickRatio := trapLong ? (lowerWick / body) : (upperWick / body)
        
        // Montar string de zonas rejeitadas
        zonesArray = array.new_string(0)
        if trapLong
            if pivotRejectionLong
                array.push(zonesArray, "SR")
            if fibRejectionLong
                array.push(zonesArray, "Fibo 0.5-0.618")
            if emaRejectionLong
                array.push(zonesArray, "EMA")
        else
            if pivotRejectionShort
                array.push(zonesArray, "SR")
            if fibRejectionShort
                array.push(zonesArray, "Fibo 0.5-0.618")
            if emaRejectionShort
                array.push(zonesArray, "EMA")
        
        signalRejectionZones := array.size(zonesArray) > 0 ? array.join(zonesArray, " + ") : "N/A"
        
        // Classifica√ß√£o de conflu√™ncia
        confluenceText = signalConfluence == 1 ? "Simples" : signalConfluence == 2 ? "Dupla ‚≠ê" : "Tripla üåüüåü"
        
        // Alerta de GATILHO
        gatilhoJson = '{"status":"TRIGGER","symbol":"' + syminfo.ticker + '","direction":"' + signalDirection + '","timeframe":"' + timeframe.period + '","price":' + str.tostring(close) + ',"triggerPrice":' + str.tostring(triggerPrice) + ',"setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + structuralTimeframe + '","fishingType":"' + signalFishingType + '","confluence":"' + confluenceText + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":' + str.tostring(signalEmasCount) + ',"wickToBodyRatio":' + str.tostring(signalWickRatio, "#.##") + '}'
        
        alert(gatilhoJson, alert.freq_once_per_bar_close)
        
        // Label de GATILHO
        if showLabels
            labelText = "üîî " + signalDirection + "\n" + signalSetupQuality + "\n" + confluenceText + "\n" + signalRejectionZones
            if signalEmasCount > 1
                labelText := labelText + "\n" + signalEmasRejected
            label.new(bar_index, trapLong ? low : high, labelText, xloc=xloc.bar_index, yloc=yloc.price, color=trapLong ? color.new(color.green, 80) : color.new(color.red, 80), style=trapLong ? label.style_label_up : label.style_label_down, textcolor=trapLong ? color.green : color.red, size=size.small)

// CONFIRMA√á√ÉO: Verificar rompimento no candle seguinte (apenas 1 candle)
if signalArmed
    barsElapsed = bar_index - signalArmedBar
    
    if barsElapsed == 1  // Apenas 1 candle depois
        if signalDirection == "LONG" and close > triggerPrice
            // CONFIRMADO LONG
            signalArmed := false
            
            // Gest√£o de Risco
            riskDistance = triggerPrice - low
            slPrice = low - (syminfo.mintick)
            tp1Price = triggerPrice + riskDistance
            tp2Price = triggerPrice + (riskDistance * 2)
            
            confluenceText = signalConfluence == 1 ? "Simples" : signalConfluence == 2 ? "Dupla ‚≠ê" : "Tripla üåüüåü"
            
            confirmadoJson = '{"status":"CONFIRMED","symbol":"' + syminfo.ticker + '","direction":"' + signalDirection + '","timeframe":"' + timeframe.period + '","entry":' + str.tostring(close) + ',"sl":' + str.tostring(slPrice) + ',"tp1":' + str.tostring(tp1Price) + ',"tp2":' + str.tostring(tp2Price) + ',"setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + structuralTimeframe + '","fishingType":"' + signalFishingType + '","confluence":"' + confluenceText + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":' + str.tostring(signalEmasCount) + ',"wickToBodyRatio":' + str.tostring(signalWickRatio, "#.##") + '}'
            
            alert(confirmadoJson, alert.freq_once_per_bar_close)
            
            // Label de CONFIRMA√á√ÉO
            if showLabels
                labelText = "‚úÖ " + signalDirection + "\n" + signalSetupQuality + "\n" + confluenceText + "\n" + signalRejectionZones
                if signalEmasCount > 1
                    labelText := labelText + "\n" + signalEmasRejected
                label.new(bar_index, low, labelText, xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.green, 0), style=label.style_label_up, textcolor=color.white, size=size.normal)
        
        else if signalDirection == "SHORT" and close < triggerPrice
            // CONFIRMADO SHORT
            signalArmed := false
            
            // Gest√£o de Risco
            riskDistance = high - triggerPrice
            slPrice = high + (syminfo.mintick)
            tp1Price = triggerPrice - riskDistance
            tp2Price = triggerPrice - (riskDistance * 2)
            
            confluenceText = signalConfluence == 1 ? "Simples" : signalConfluence == 2 ? "Dupla ‚≠ê" : "Tripla üåüüåü"
            
            confirmadoJson = '{"status":"CONFIRMED","symbol":"' + syminfo.ticker + '","direction":"' + signalDirection + '","timeframe":"' + timeframe.period + '","entry":' + str.tostring(close) + ',"sl":' + str.tostring(slPrice) + ',"tp1":' + str.tostring(tp1Price) + ',"tp2":' + str.tostring(tp2Price) + ',"setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + structuralTimeframe + '","fishingType":"' + signalFishingType + '","confluence":"' + confluenceText + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":' + str.tostring(signalEmasCount) + ',"wickToBodyRatio":' + str.tostring(signalWickRatio, "#.##") + '}'
            
            alert(confirmadoJson, alert.freq_once_per_bar_close)
            
            // Label de CONFIRMA√á√ÉO
            if showLabels
                labelText = "‚úÖ " + signalDirection + "\n" + signalSetupQuality + "\n" + confluenceText + "\n" + signalRejectionZones
                if signalEmasCount > 1
                    labelText := labelText + "\n" + signalEmasRejected
                label.new(bar_index, high, labelText, xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.red, 0), style=label.style_label_down, textcolor=color.white, size=size.normal)
        
        else
            // EXPIRADO (n√£o rompeu no candle seguinte)
            signalArmed := false
    else if barsElapsed > 1
        // EXPIRADO (passou do candle seguinte)
        signalArmed := false
