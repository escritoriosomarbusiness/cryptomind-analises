// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© CryptoMind IA - STS (Stormer Trap Setup) v1.0

//@version=6
indicator("STS by CryptoMind v1.0", shorttitle="STS v1.0", overlay=true, max_labels_count=50)

// ============================================
// CONFIGURA√á√ïES GERAIS
// ============================================
wickToBodyRatio = input.float(2.0, "Propor√ß√£o M√≠n. Pavio/Corpo", minval=1.5, maxval=3.0, step=0.1, group="Candle Martelo", tooltip="Pavio deve ser >= X vezes o corpo")
cooldownCandles = input.int(5, "Cooldown entre sinais", minval=5, maxval=30, group="Geral")
showLabels = input.bool(true, "Mostrar Labels", group="Visual")

// ============================================
// CONFIGURA√á√ïES - M√öLTIPLAS EMAs
// ============================================
useEMA13 = input.bool(false, "EMA 13", group="EMAs")
useEMA21 = input.bool(false, "EMA 21", group="EMAs")
useEMA34 = input.bool(false, "EMA 34", group="EMAs")
useEMA55 = input.bool(false, "EMA 55", group="EMAs")
useEMA89 = input.bool(true, "EMA 89", group="EMAs")
useEMA144 = input.bool(false, "EMA 144", group="EMAs")
useEMA233 = input.bool(false, "EMA 233", group="EMAs")
showEMAs = input.bool(true, "Mostrar EMAs Selecionadas", group="EMAs")
emaTolerance = input.float(0.2, "Toler√¢ncia Toque EMA (%)", minval=0.1, maxval=1.0, step=0.1, group="EMAs")

// ============================================
// CONFIGURA√á√ïES - PIVOTS MULTI-TIMEFRAME
// ============================================
usePivots = input.bool(true, "Usar Pivots (SR) do HTF", group="Pivots MTF", tooltip="Busca suporte/resist√™ncia do timeframe superior")
pivotLookback = input.int(10, "Lookback para Pivots", minval=5, maxval=50, group="Pivots MTF")
pivotTolerance = input.float(0.1, "Toler√¢ncia zona SR (%)", minval=0.1, maxval=2.0, step=0.1, group="Pivots MTF")
showPivots = input.bool(false, "Mostrar Pivots (SR)", group="Pivots MTF")

// ============================================
// CONFIGURA√á√ïES - FIBONACCI (GOLDEN ZONE)
// ============================================
useFibonacci = input.bool(true, "Usar Golden Zone (Fibo 0.5-0.618)", group="Fibonacci", tooltip="Busca retra√ß√£o de Fibonacci do HTF")
fibLookback = input.int(10, "Lookback para Pivots Fibonacci", minval=5, maxval=20, group="Fibonacci")

// ============================================
// DETEC√á√ÉO AUTOM√ÅTICA DE TIMEFRAME ESTRUTURAL
// ============================================
getStructuralTimeframe() =>
    currentTF = timeframe.period
    
    // Mapeamento: TF Operacional -> TF Estrutural (HTF)
    structuralTF = switch currentTF
        "1"   => "15"      // 1 min -> 15 min
        "5"   => "60"      // 5 min -> 1 hora
        "15"  => "240"     // 15 min -> 4 horas
        "60"  => "D"       // 1 hora -> Di√°rio
        "240" => "W"       // 4 horas -> Semanal
        "D"   => "M"       // Di√°rio -> Mensal
        => "60"            // Default: 1 hora
    
    structuralTF

structuralTimeframe = getStructuralTimeframe()

// ============================================
// FILTRO DE TEND√äNCIA MULTI-TIMEFRAME (MTF)
// ============================================

// Buscar dados do timeframe superior para an√°lise macro
var float htf_ema55 = na
var float htf_ema233 = na
var float htf_close = na
var float htf_ema55_prev = na
var bool htf_trendUp = false
var bool htf_trendDown = false
var bool htf_trendNeutral = true
var string htf_trendText = "NEUTRO"

if structuralTimeframe != ""
    // Buscar EMAs do timeframe superior
    htf_ema55 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 55), lookahead=barmerge.lookahead_off)
    htf_ema233 := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 233), lookahead=barmerge.lookahead_off)
    htf_close := request.security(syminfo.tickerid, structuralTimeframe, close, lookahead=barmerge.lookahead_off)
    htf_ema55_prev := request.security(syminfo.tickerid, structuralTimeframe, ta.ema(close, 55)[1], lookahead=barmerge.lookahead_off)
    
    // Determinar tend√™ncia do fractal superior
    if na(htf_ema55) or na(htf_ema233) or na(htf_ema55_prev)
        htf_trendUp := false
        htf_trendDown := false
        htf_trendNeutral := true
        htf_trendText := "NEUTRO"
    else
        htf_trendUp := htf_ema55 > htf_ema233 and htf_ema55 > htf_ema55_prev and htf_close > htf_ema55
        htf_trendDown := htf_ema55 < htf_ema233 and htf_ema55 < htf_ema55_prev and htf_close < htf_ema55
        htf_trendNeutral := not htf_trendUp and not htf_trendDown
        htf_trendText := htf_trendUp ? "ALTA" : htf_trendDown ? "BAIXA" : "NEUTRO"

// ============================================
// C√ÅLCULO DAS EMAs
// ============================================
ema13 = ta.ema(close, 13)
ema21 = ta.ema(close, 21)
ema34 = ta.ema(close, 34)
ema55 = ta.ema(close, 55)
ema89 = ta.ema(close, 89)
ema144 = ta.ema(close, 144)
ema233 = ta.ema(close, 233)

// Plotar EMAs selecionadas
plot(showEMAs and useEMA13 ? ema13 : na, "EMA 13", color=color.new(color.purple, 0), linewidth=1)
plot(showEMAs and useEMA21 ? ema21 : na, "EMA 21", color=color.new(color.blue, 0), linewidth=1)
plot(showEMAs and useEMA34 ? ema34 : na, "EMA 34", color=color.new(color.teal, 0), linewidth=1)
plot(showEMAs and useEMA55 ? ema55 : na, "EMA 55", color=color.new(color.green, 0), linewidth=2)
plot(showEMAs and useEMA89 ? ema89 : na, "EMA 89", color=color.new(color.orange, 0), linewidth=2)
plot(showEMAs and useEMA144 ? ema144 : na, "EMA 144", color=color.new(color.red, 0), linewidth=2)
plot(showEMAs and useEMA233 ? ema233 : na, "EMA 233", color=color.new(color.maroon, 0), linewidth=2)

// ============================================
// DETEC√á√ÉO DE PIVOTS (MULTI-TIMEFRAME)
// ============================================
// Buscar pivots do timeframe estrutural
pivotHighSource = usePivots ? request.security(syminfo.tickerid, structuralTimeframe, ta.pivothigh(high, pivotLookback, pivotLookback), lookahead=barmerge.lookahead_on) : na
pivotLowSource = usePivots ? request.security(syminfo.tickerid, structuralTimeframe, ta.pivotlow(low, pivotLookback, pivotLookback), lookahead=barmerge.lookahead_on) : na

var float lastPivotHigh = na
var float lastPivotLow = na

if not na(pivotHighSource)
    lastPivotHigh := pivotHighSource

if not na(pivotLowSource)
    lastPivotLow := pivotLowSource

plot(showPivots and usePivots and not na(lastPivotHigh) ? lastPivotHigh : na, "Resist√™ncia HTF", color=color.red, style=plot.style_circles, linewidth=2)
plot(showPivots and usePivots and not na(lastPivotLow) ? lastPivotLow : na, "Suporte HTF", color=color.green, style=plot.style_circles, linewidth=2)

// ============================================
// DETEC√á√ÉO DE PIVOTS PARA FIBONACCI (MTF)
// ============================================
var array<float> pivotHighs = array.new<float>()
var array<int> pivotHighBars = array.new<int>()
var array<float> pivotLows = array.new<float>()
var array<int> pivotLowBars = array.new<int>()

if useFibonacci and not na(pivotHighSource)
    array.unshift(pivotHighs, pivotHighSource)
    array.unshift(pivotHighBars, bar_index - pivotLookback)
    if array.size(pivotHighs) > fibLookback
        array.pop(pivotHighs)
        array.pop(pivotHighBars)

if useFibonacci and not na(pivotLowSource)
    array.unshift(pivotLows, pivotLowSource)
    array.unshift(pivotLowBars, bar_index - pivotLookback)
    if array.size(pivotLows) > fibLookback
        array.pop(pivotLows)
        array.pop(pivotLowBars)

// ============================================
// C√ÅLCULO DA GOLDEN ZONE (FIBONACCI)
// ============================================
var float fibHigh = na
var float fibLow = na
var float goldenZoneTop = na
var float goldenZoneBottom = na

// Para LONG: buscar √∫ltimo fundo (low) e √∫ltimo topo (high)
if useFibonacci and array.size(pivotLows) >= 1 and array.size(pivotHighs) >= 1
    fibLow := array.get(pivotLows, 0)
    fibHigh := array.get(pivotHighs, 0)
    
    if fibHigh > fibLow
        fibRange = fibHigh - fibLow
        goldenZoneTop := fibLow + (fibRange * 0.618)
        goldenZoneBottom := fibLow + (fibRange * 0.5)

// Para SHORT: mesmos pivots, interpreta√ß√£o invertida
var float goldenZoneTopShort = na
var float goldenZoneBottomShort = na

if useFibonacci and array.size(pivotHighs) >= 1 and array.size(pivotLows) >= 1
    fibHighShort = array.get(pivotHighs, 0)
    fibLowShort = array.get(pivotLows, 0)
    
    if fibHighShort > fibLowShort
        fibRangeShort = fibHighShort - fibLowShort
        goldenZoneTopShort := fibHighShort - (fibRangeShort * 0.5)
        goldenZoneBottomShort := fibHighShort - (fibRangeShort * 0.618)

// ============================================
// DETEC√á√ÉO DE CANDLE MARTELO
// ============================================
body = math.abs(close - open)
upperWick = high - math.max(open, close)
lowerWick = math.min(open, close) - low

// Validar martelo LONG (pavio inferior grande + candle de alta)
isHammerLong = body > 0 and lowerWick >= (body * wickToBodyRatio) and close > open

// Validar martelo SHORT (pavio superior grande + candle de baixa)
isHammerShort = body > 0 and upperWick >= (body * wickToBodyRatio) and close < open

// Calcular propor√ß√£o real
wickToBodyRatioActual = body > 0 ? (isHammerLong ? lowerWick / body : isHammerShort ? upperWick / body : 0) : 0

// ============================================
// DETEC√á√ÉO DE REJEI√á√ÉO EM M√öLTIPLAS EMAs
// ============================================
emaToleranceValue = close * (emaTolerance / 100)

var int emasRejectedCount = 0
var string emasRejectedList = ""

emasRejectedCount := 0
emasRejectedList := ""

// LONG: Pavio toca EMA + fecha acima
if isHammerLong
    if useEMA13 and low <= (ema13 + emaToleranceValue) and close > ema13
        emasRejectedCount += 1
        emasRejectedList += "13,"
    
    if useEMA21 and low <= (ema21 + emaToleranceValue) and close > ema21
        emasRejectedCount += 1
        emasRejectedList += "21,"
    
    if useEMA34 and low <= (ema34 + emaToleranceValue) and close > ema34
        emasRejectedCount += 1
        emasRejectedList += "34,"
    
    if useEMA55 and low <= (ema55 + emaToleranceValue) and close > ema55
        emasRejectedCount += 1
        emasRejectedList += "55,"
    
    if useEMA89 and low <= (ema89 + emaToleranceValue) and close > ema89
        emasRejectedCount += 1
        emasRejectedList += "89,"
    
    if useEMA144 and low <= (ema144 + emaToleranceValue) and close > ema144
        emasRejectedCount += 1
        emasRejectedList += "144,"
    
    if useEMA233 and low <= (ema233 + emaToleranceValue) and close > ema233
        emasRejectedCount += 1
        emasRejectedList += "233,"

// SHORT: Pavio toca EMA + fecha abaixo
if isHammerShort
    if useEMA13 and high >= (ema13 - emaToleranceValue) and close < ema13
        emasRejectedCount += 1
        emasRejectedList += "13,"
    
    if useEMA21 and high >= (ema21 - emaToleranceValue) and close < ema21
        emasRejectedCount += 1
        emasRejectedList += "21,"
    
    if useEMA34 and high >= (ema34 - emaToleranceValue) and close < ema34
        emasRejectedCount += 1
        emasRejectedList += "34,"
    
    if useEMA55 and high >= (ema55 - emaToleranceValue) and close < ema55
        emasRejectedCount += 1
        emasRejectedList += "55,"
    
    if useEMA89 and high >= (ema89 - emaToleranceValue) and close < ema89
        emasRejectedCount += 1
        emasRejectedList += "89,"
    
    if useEMA144 and high >= (ema144 - emaToleranceValue) and close < ema144
        emasRejectedCount += 1
        emasRejectedList += "144,"
    
    if useEMA233 and high >= (ema233 - emaToleranceValue) and close < ema233
        emasRejectedCount += 1
        emasRejectedList += "233,"

// Remover √∫ltima v√≠rgula
if str.length(emasRejectedList) > 0
    emasRejectedList := str.substring(emasRejectedList, 0, str.length(emasRejectedList) - 1)

emaRejected = emasRejectedCount > 0

// ============================================
// VALIDA√á√ÉO PIVOTS (SR)
// ============================================
pivotToleranceValue = close * (pivotTolerance / 100)

// LONG: Pavio toca suporte + fecha acima
srRejectedLong = usePivots and not na(lastPivotLow) and low <= (lastPivotLow + pivotToleranceValue) and close > lastPivotLow

// SHORT: Pavio toca resist√™ncia + fecha abaixo
srRejectedShort = usePivots and not na(lastPivotHigh) and high >= (lastPivotHigh - pivotToleranceValue) and close < lastPivotHigh

// ============================================
// VALIDA√á√ÉO FIBONACCI (GOLDEN ZONE)
// ============================================

// LONG: Pavio toca Golden Zone + fecha acima de 0.618
fiboRejectedLong = useFibonacci and not na(goldenZoneTop) and not na(goldenZoneBottom) and low <= goldenZoneTop and low >= goldenZoneBottom and close > goldenZoneTop

// SHORT: Pavio toca Golden Zone + fecha abaixo de 0.618
fiboRejectedShort = useFibonacci and not na(goldenZoneTopShort) and not na(goldenZoneBottomShort) and high >= goldenZoneBottomShort and high <= goldenZoneTopShort and close < goldenZoneBottomShort

// ============================================
// SISTEMA DE CONFLU√äNCIAS
// ============================================
var int zonesRejected = 0
var string confluenceText = ""
var string rejectionZones = ""

zonesRejected := 0
rejectionZones := ""

// Contar zonas rejeitadas para LONG
if isHammerLong
    if srRejectedLong
        zonesRejected += 1
        rejectionZones += "SR,"
    
    if fiboRejectedLong
        zonesRejected += 1
        rejectionZones += "Fibo,"
    
    if emaRejected
        zonesRejected += 1
        rejectionZones += "EMA,"

// Contar zonas rejeitadas para SHORT
if isHammerShort
    if srRejectedShort
        zonesRejected += 1
        rejectionZones += "SR,"
    
    if fiboRejectedShort
        zonesRejected += 1
        rejectionZones += "Fibo,"
    
    if emaRejected
        zonesRejected += 1
        rejectionZones += "EMA,"

// Remover √∫ltima v√≠rgula
if str.length(rejectionZones) > 0
    rejectionZones := str.substring(rejectionZones, 0, str.length(rejectionZones) - 1)

// Classificar conflu√™ncia
confluenceText := zonesRejected == 1 ? "Simples" : 
                  zonesRejected == 2 ? "Dupla ‚≠ê" : 
                  zonesRejected == 3 ? "Tripla üåüüåü" : "Nenhuma"

// ============================================
// VALIDA√á√ÉO COMPLETA DA TRAP
// ============================================

// TRAP LONG: Martelo + Rejei√ß√£o de zona + Pelo menos 1 conflu√™ncia
trapLong = isHammerLong and zonesRejected >= 1

// TRAP SHORT: Martelo invertido + Rejei√ß√£o de zona + Pelo menos 1 conflu√™ncia
trapShort = isHammerShort and zonesRejected >= 1

// ============================================
// CLASSIFICA√á√ÉO MTF E FISHING TYPE
// ============================================
var string setupQuality = "CAUTELA"
var string fishingType = "NONE"

if trapLong
    if htf_trendUp
        setupQuality := "PREMIUM"
        fishingType := "NONE"
    else if htf_trendDown
        setupQuality := "CONTRA"
        fishingType := "BOTTOM"
    else
        setupQuality := "CAUTELA"
        fishingType := "NONE"

if trapShort
    if htf_trendDown
        setupQuality := "PREMIUM"
        fishingType := "NONE"
    else if htf_trendUp
        setupQuality := "CONTRA"
        fishingType := "TOP"
    else
        setupQuality := "CAUTELA"
        fishingType := "NONE"

// ============================================
// COOLDOWN
// ============================================
var int lastSignalBar = na
cooldownOk = na(lastSignalBar) or (bar_index - lastSignalBar) >= cooldownCandles

// ============================================
// SISTEMA DE CONFIRMA√á√ÉO POR ROMPIMENTO
// ============================================
var bool signalArmed = false
var float triggerPrice = na
var string signalDirection = ""
var int signalArmedBar = na
var float signalSlPrice = na
var float signalTp1Price = na
var float signalTp2Price = na
var string signalSetupQuality = ""
var string signalFishingType = ""
var string signalConfluence = ""
var string signalRejectionZones = ""
var string signalEmasRejected = ""
var int signalEmasCount = 0
var float signalWickRatio = 0.0

// GATILHO: Armar sinal (apenas se n√£o for CAUTELA)
if (trapLong or trapShort) and cooldownOk and not signalArmed and setupQuality != "CAUTELA"
    signalArmed := true
    signalDirection := trapLong ? "LONG" : "SHORT"
    triggerPrice := trapLong ? high : low
    signalArmedBar := bar_index
    signalSetupQuality := setupQuality
    signalFishingType := fishingType
    signalConfluence := confluenceText
    signalRejectionZones := rejectionZones
    signalEmasRejected := emasRejectedList
    signalEmasCount := emasRejectedCount
    signalWickRatio := wickToBodyRatioActual
    
    // Calcular SL, TP1, TP2
    signalSlPrice := trapLong ? low - syminfo.mintick : high + syminfo.mintick
    riskDistance = math.abs(triggerPrice - signalSlPrice)
    signalTp1Price := trapLong ? triggerPrice + riskDistance : triggerPrice - riskDistance
    signalTp2Price := trapLong ? triggerPrice + (riskDistance * 2) : triggerPrice - (riskDistance * 2)
    
    // Atualizar √∫ltimo sinal
    lastSignalBar := bar_index
    
    // Alerta de GATILHO
    gatilhoJson = '{"status":"TRIGGER","symbol":"' + syminfo.ticker + '","direction":"' + signalDirection + '","timeframe":"' + timeframe.period + '","price":' + str.tostring(close) + ',"trigger":' + str.tostring(triggerPrice) + ',"sl":' + str.tostring(signalSlPrice) + ',"tp1":' + str.tostring(signalTp1Price) + ',"tp2":' + str.tostring(signalTp2Price) + ',"setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + structuralTimeframe + '","fishingType":"' + signalFishingType + '","confluence":"' + signalConfluence + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":' + str.tostring(signalEmasCount) + ',"wickToBodyRatio":' + str.tostring(signalWickRatio, "#.##") + '}'
    
    alert(gatilhoJson, alert.freq_once_per_bar_close)
    
    // Label de GATILHO
    if showLabels
        labelText = "üîî " + signalDirection + "\n" + signalSetupQuality + "\n" + signalConfluence + "\n" + signalRejectionZones
        if signalEmasCount > 1
            labelText := labelText + "\n" + signalEmasRejected
        label.new(bar_index, trapLong ? low : high, 
            labelText, 
            color=trapLong ? color.new(color.green, 80) : color.new(color.red, 80), 
            style=trapLong ? label.style_label_up : label.style_label_down, 
            textcolor=trapLong ? color.green : color.red, 
            size=size.small)

// CONFIRMA√á√ÉO: Verificar rompimento no candle seguinte (apenas 1 candle)
if signalArmed
    barsElapsed = bar_index - signalArmedBar
    
    if barsElapsed == 1  // Apenas 1 candle depois
        if signalDirection == "LONG" and close > triggerPrice
            // CONFIRMADO LONG
            signalArmed := false
            
            // Alerta de CONFIRMA√á√ÉO
            confirmadoJson = '{"status":"CONFIRMED","symbol":"' + syminfo.ticker + '","direction":"' + signalDirection + '","timeframe":"' + timeframe.period + '","entry":' + str.tostring(close) + ',"sl":' + str.tostring(signalSlPrice) + ',"tp1":' + str.tostring(signalTp1Price) + ',"tp2":' + str.tostring(signalTp2Price) + ',"setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + structuralTimeframe + '","fishingType":"' + signalFishingType + '","confluence":"' + signalConfluence + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":' + str.tostring(signalEmasCount) + ',"wickToBodyRatio":' + str.tostring(signalWickRatio, "#.##") + '}'
            
            alert(confirmadoJson, alert.freq_once_per_bar_close)
            
            // Label de CONFIRMA√á√ÉO
            if showLabels
                labelText = "‚úÖ " + signalDirection + "\n" + signalSetupQuality + "\n" + signalConfluence + "\n" + signalRejectionZones
                if signalEmasCount > 1
                    labelText := labelText + "\n" + signalEmasRejected
                label.new(bar_index, low, 
                    labelText, 
                    color=color.new(color.green, 0), 
                    style=label.style_label_up, 
                    textcolor=color.white, 
                    size=size.normal)
        
        else if signalDirection == "SHORT" and close < triggerPrice
            // CONFIRMADO SHORT
            signalArmed := false
            
            // Alerta de CONFIRMA√á√ÉO
            confirmadoJson = '{"status":"CONFIRMED","symbol":"' + syminfo.ticker + '","direction":"' + signalDirection + '","timeframe":"' + timeframe.period + '","entry":' + str.tostring(close) + ',"sl":' + str.tostring(signalSlPrice) + ',"tp1":' + str.tostring(signalTp1Price) + ',"tp2":' + str.tostring(signalTp2Price) + ',"setupQuality":"' + signalSetupQuality + '","htfTrend":"' + htf_trendText + '","htfTimeframe":"' + structuralTimeframe + '","fishingType":"' + signalFishingType + '","confluence":"' + signalConfluence + '","rejectionZones":"' + signalRejectionZones + '","emasRejected":"' + signalEmasRejected + '","emasCount":' + str.tostring(signalEmasCount) + ',"wickToBodyRatio":' + str.tostring(signalWickRatio, "#.##") + '}'
            
            alert(confirmadoJson, alert.freq_once_per_bar_close)
            
            // Label de CONFIRMA√á√ÉO
            if showLabels
                labelText = "‚úÖ " + signalDirection + "\n" + signalSetupQuality + "\n" + signalConfluence + "\n" + signalRejectionZones
                if signalEmasCount > 1
                    labelText := labelText + "\n" + signalEmasRejected
                label.new(bar_index, high, 
                    labelText, 
                    color=color.new(color.red, 0), 
                    style=label.style_label_down, 
                    textcolor=color.white, 
                    size=size.normal)
        
        else
            // EXPIRADO (n√£o rompeu no candle seguinte)
            signalArmed := false
    
    else if barsElapsed > 1
        // EXPIRADO (passou do candle seguinte)
        signalArmed := false

// ============================================
// PLOTAR TRIGGER PRICE (quando sinal armado)
// ============================================
// plot(signalArmed ? triggerPrice : na, "Trigger Price", color=color.yellow, style=plot.style_cross, linewidth=2) // REMOVIDO: linha fixa
